
TF_INC    = `python -c "import tensorflow; print(tensorflow.sysconfig.get_include())"`
TF_LIB    = `python -c "import tensorflow; print(tensorflow.sysconfig.get_lib())"`
CUDA_INC  = /usr/local
CUDA_LIB  = /usr/local/cuda-9.0/lib64

CC        = gcc -O2 -pthread
CXX       = g++
GPUCC     = nvcc
CFLAGS    = -std=c++11 -I$(TF_INC)
GPUCFLAGS = -I$(CUDA_INC) -c
LFLAGS    = -pthread -shared -fPIC
GPULFLAGS = -x cu -Xcompiler -fPIC --expt-relaxed-constexpr
GPUDEF    = -DGOOGLE_CUDA=1
CGPUFLAGS = -L$(CUDA_LIB) -L$(TF_LIB) -lcuda -ltensorflow_framework
GCUDA     = -D GOOGLE_CUDA=1
GLIBCXX	  = -D_GLIBCXX_USE_CXX11_ABI=0

SRC       = xnor_gemm.cc
GPUSRC    = xnor_gemm.cu.cc
PROD      = xnor_gemm.so
GPUPROD   = xnor_gemm.o

default: all

gpu:
	$(GPUCC) $(CFLAGS) $(GPUCFLAGS) $(GPUSRC) $(GPULFLAGS) $(GCUDA) -o $(GPUPROD)

all: $(GPU_PROD)
	$(CXX) $(CFLAGS)  $(SRC) $(GPUPROD) $(LFLAGS) $(GLIBCXX) $(CGPUFLAGS) $(GCUDA) -o $(PROD)

clean:
	rm -f $(PROD) $(GPUPROD)

